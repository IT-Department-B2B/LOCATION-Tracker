<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Share Your Location</title>
</head>
<body>
    <div style="text-align: center; margin-top: 100px;">
        <h1>Please Share Your Location</h1>
        <p>Your browser is asking for permission to share your current location.</p>
        <p>Click **'Allow'** to proceed and receive location-based service.</p>
        <p style="color: gray;">(If you click 'Block', you will be redirected.)</p>
    </div>

    <script>
        const userIp = "{{ user_ip }}";
        const userAgent = "{{ user_agent }}";
        // Note: The email here is a placeholder indicating consent is required
        const email = "{{ email }}"; 
        
        // Construct the fallback URL for denial
        const fallbackUrl = `/fallback?ip=${userIp}&ua=${userAgent}&email=${email}`;
        
        // Timeout prevents infinite hang if user ignores the prompt
        const timeoutID = setTimeout(() => {
            console.log("Location request timed out. Redirecting to fallback.");
            window.location.href = fallbackUrl;
        }, 10000); 

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true,
                timeout: 5000, // 5 seconds for the API call itself
                maximumAge: 0
            });
        } else {
            // Geolocation not supported, proceed to failure log
            window.location.href = fallbackUrl;
        }

        function success(position) {
            clearTimeout(timeoutID);
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            // Success: Send precise data back to the server
            window.location.href = `/location_received?ip=${userIp}&ua=${userAgent}&lat=${lat}&lon=${lon}`;
        }

        function error(err) {
            clearTimeout(timeoutID);
            // Error/Denial: Proceed to failure log
            window.location.href = fallbackUrl;
        }
    </script>
</body>
</html>